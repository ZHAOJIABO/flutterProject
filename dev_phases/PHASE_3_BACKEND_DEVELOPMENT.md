# 第三阶段：后端开发（可选）

**时间：第 17-24 周（80-160 小时）**

**状态：** 🟡 未开始

**负责人：** [填写你的名字]

**开始日期：** [填写开始日期]

**预计完成日期：** [填写预计完成日期]

**前置条件：** 完成第二阶段的 Flutter 前端开发

---

## ⚠️ 重要决策：是否需要后端？

在开始本阶段前，请先回答以下问题：

### 评估问卷

- [ ] **是否需要用户账号系统？**（登录、注册、用户信息管理）
- [ ] **是否需要多端数据同步？**（iOS、Android、Web 之间同步）
- [ ] **是否有复杂的业务逻辑？**（支付、订单、库存等）
- [ ] **是否需要隐藏 API 密钥？**（第三方服务的 Secret Key）
- [ ] **是否需要服务器端推送？**（实时通知、消息推送）
- [ ] **预期用户量是否 > 10,000？**

**如果以上问题有 3 个或以上回答"是"，建议自建后端。**

**如果少于 3 个，强烈推荐使用 BaaS（Backend as a Service）。**

---

## 🚀 方案 A：使用 BaaS（推荐新手）

### 为什么推荐 BaaS？

- ✅ **快速上线**：无需编写后端代码，几小时内完成集成
- ✅ **成本低**：免费额度足够 MVP 使用
- ✅ **维护简单**：无需管理服务器、数据库
- ✅ **功能完整**：用户认证、数据库、存储、推送一应俱全
- ✅ **可扩展**：支持从免费版升级到付费版

---

### 推荐方案 1：Supabase（强烈推荐）

**优势：**
- 开源，数据可导出，不担心厂商锁定
- 基于 PostgreSQL，支持 SQL 查询
- 实时订阅功能（WebSocket）
- Row Level Security（数据安全）
- 免费额度：500MB 数据库、1GB 文件存储、2GB 带宽/月

**集成时间：** 1-2 周（10-20 小时）

#### 任务清单

- [ ] **注册和配置**（2-3小时）
  - [ ] 注册 Supabase 账号
  - [ ] 创建项目
  - [ ] 获取 API URL 和 Key
  - [ ] 配置数据库

- [ ] **数据库设计**（3-5小时）
  - [ ] 设计数据表结构
  - [ ] 使用 SQL 创建表
  - [ ] 配置表关系（外键）
  - [ ] 设置 Row Level Security 策略
  - [ ] 创建索引（性能优化）

- [ ] **Flutter 集成**（5-12小时）
  - [ ] 安装 Supabase Flutter SDK
    ```yaml
    dependencies:
      supabase_flutter: ^2.3.0
    ```
  - [ ] 初始化 Supabase 客户端
  - [ ] 实现用户认证（登录/注册/登出）
  - [ ] 实现数据 CRUD 操作
  - [ ] 实现文件上传（如需要）
  - [ ] 实现实时订阅（如需要）
  - [ ] 测试所有功能

**完成标准：**
- 用户可以注册和登录
- 数据可以正常读写
- 文件可以正常上传和访问

---

### 推荐方案 2：Firebase（备选）

**优势：**
- Google 官方支持，文档完善
- 功能丰富（推送、分析、Crashlytics）
- 免费额度较大
- 中国可访问（注意网络）

**劣势：**
- NoSQL 数据库（Firestore），学习曲线
- 数据迁移困难，厂商锁定

**集成时间：** 1-2 周（10-20 小时）

#### 任务清单

- [ ] **注册和配置**（2-3小时）
  - [ ] 注册 Firebase 账号
  - [ ] 创建项目
  - [ ] 配置 iOS 和 Android 应用
  - [ ] 下载配置文件（google-services.json 等）

- [ ] **数据库设计**（3-5小时）
  - [ ] 设计 Firestore 数据结构（集合和文档）
  - [ ] 配置安全规则
  - [ ] 创建索引

- [ ] **Flutter 集成**（5-12小时）
  - [ ] 安装 Firebase Flutter 插件
  - [ ] 初始化 Firebase
  - [ ] 实现用户认证
  - [ ] 实现数据 CRUD
  - [ ] 实现文件上传
  - [ ] 集成 Firebase Analytics（可选）
  - [ ] 集成 Crashlytics（可选）

**完成标准：**
- 所有 Firebase 服务正常工作
- 数据可以正常读写

---

## 🛠️ 方案 B：自建 Go 后端

> 仅当决定自建后端时执行此部分

### Week 17-18：Go 后端项目搭建（20-40小时）

#### 1. 开发环境配置（2-4小时）

- [ ] **安装 Go**
  - [ ] 安装 Go（最新稳定版）
  - [ ] 配置 GOPATH 和 GOROOT
  - [ ] 验证安装：`go version`

- [ ] **IDE 配置**
  - [ ] 安装 VSCode 或 GoLand
  - [ ] 安装 Go 插件
  - [ ] 配置代码格式化

- [ ] **数据库安装**
  - [ ] 安装 PostgreSQL 或 MySQL
  - [ ] 创建数据库
  - [ ] 安装数据库管理工具（DBeaver/TablePlus）

- [ ] **其他工具**
  - [ ] 安装 Docker（用于部署）
  - [ ] 安装 Postman（API 测试）

**完成标准：**
- Go 环境正常运行
- 数据库可以正常连接

---

#### 2. 项目结构搭建（6-12小时）

- [ ] **创建项目**
  - [ ] 初始化 Go Modules：`go mod init [项目名]`
  - [ ] 创建项目目录结构
  - [ ] 初始化 Git 仓库

**推荐项目结构：**
```
backend/
├── cmd/
│   └── api/
│       └── main.go           # 程序入口
├── internal/
│   ├── config/               # 配置管理
│   ├── models/               # 数据模型（数据库表）
│   ├── repository/           # 数据访问层（DAO）
│   ├── service/              # 业务逻辑层
│   ├── handler/              # HTTP 处理器（Controller）
│   ├── middleware/           # 中间件（认证、日志等）
│   ├── router/               # 路由配置
│   └── utils/                # 工具函数
├── pkg/                      # 可复用的公共包
│   ├── jwt/                  # JWT 认证
│   ├── validator/            # 输入验证
│   └── response/             # 统一响应格式
├── migrations/               # 数据库迁移文件
├── docs/                     # API 文档（Swagger）
├── scripts/                  # 脚本文件
├── .env                      # 环境变量
├── .env.example              # 环境变量示例
├── Dockerfile
├── docker-compose.yml
├── go.mod
├── go.sum
├── Makefile                  # 常用命令
└── README.md
```

- [ ] **安装依赖**
  ```bash
  # Web 框架
  go get -u github.com/gin-gonic/gin

  # ORM
  go get -u gorm.io/gorm
  go get -u gorm.io/driver/postgres  # 或 mysql

  # JWT
  go get -u github.com/golang-jwt/jwt/v5

  # 环境变量
  go get -u github.com/joho/godotenv

  # 验证器
  go get -u github.com/go-playground/validator/v10

  # Swagger 文档
  go get -u github.com/swaggo/gin-swagger
  go get -u github.com/swaggo/files
  ```

- [ ] **编写基础代码**
  - [ ] main.go（程序入口）
  - [ ] config.go（配置管理）
  - [ ] database.go（数据库连接）
  - [ ] router.go（路由配置）
  - [ ] response.go（统一响应格式）

**完成标准：**
- 项目可以正常启动
- 数据库可以正常连接
- 可以访问 Hello World 接口

---

#### 3. 数据库设计和迁移（6-12小时）

- [ ] **设计数据库表**
  - [ ] 根据功能需求设计表结构
  - [ ] 绘制 ER 图（实体关系图）
  - [ ] 确定字段类型和约束
  - [ ] 设计索引（性能优化）

- [ ] **创建 Model 类**
  - [ ] 使用 GORM 定义 Model
  - [ ] 添加字段验证标签
  - [ ] 定义表关系（一对多、多对多）

- [ ] **数据库迁移**
  - [ ] 使用 GORM AutoMigrate 或手写 SQL
  - [ ] 测试数据库表创建
  - [ ] 插入测试数据

**完成标准：**
- 数据库表创建成功
- 表结构符合设计
- 测试数据插入成功

---

#### 4. 用户认证系统（6-12小时）

- [ ] **JWT 认证实现**
  - [ ] 实现 JWT Token 生成
  - [ ] 实现 JWT Token 验证
  - [ ] 实现 Token 刷新机制
  - [ ] 实现认证中间件

- [ ] **用户注册 API**
  - [ ] POST /api/auth/register
  - [ ] 邮箱/手机号验证
  - [ ] 密码加密（bcrypt）
  - [ ] 返回 Token

- [ ] **用户登录 API**
  - [ ] POST /api/auth/login
  - [ ] 验证用户名和密码
  - [ ] 返回 Token 和用户信息

- [ ] **用户登出 API**
  - [ ] POST /api/auth/logout
  - [ ] Token 黑名单（可选）

- [ ] **获取用户信息 API**
  - [ ] GET /api/auth/me
  - [ ] 需要认证
  - [ ] 返回当前用户信息

**完成标准：**
- 用户可以注册和登录
- Token 正确生成和验证
- 认证中间件正常工作

---

### Week 19-20：业务 API 开发（20-40小时）

#### 5. RESTful API 开发

> 为每个核心功能开发 API，以下是通用流程模板

**为每个资源重复以下步骤：**

- [ ] **资源 1：[资源名称]**（预计 XX 小时）

  **Step 1：定义 Model**
  - [ ] 创建 Model 结构体（GORM）
  - [ ] 定义字段和验证规则
  - [ ] 定义表关系

  **Step 2：创建 Repository**
  - [ ] 实现 Create（创建）
  - [ ] 实现 GetByID（根据 ID 获取）
  - [ ] 实现 GetList（列表，带分页、搜索、排序）
  - [ ] 实现 Update（更新）
  - [ ] 实现 Delete（删除）

  **Step 3：创建 Service**
  - [ ] 实现业务逻辑
  - [ ] 数据验证
  - [ ] 权限检查
  - [ ] 调用 Repository

  **Step 4：创建 Handler**
  - [ ] 实现 HTTP 处理器
  - [ ] 解析请求参数
  - [ ] 调用 Service
  - [ ] 返回响应

  **Step 5：配置路由**
  - [ ] POST /api/[resources] - 创建
  - [ ] GET /api/[resources] - 列表
  - [ ] GET /api/[resources]/:id - 详情
  - [ ] PUT /api/[resources]/:id - 更新
  - [ ] DELETE /api/[resources]/:id - 删除

  **Step 6：编写 Swagger 文档**
  - [ ] 添加 API 注释
  - [ ] 生成 Swagger 文档
  - [ ] 测试文档是否正确

  **Step 7：测试**
  - [ ] 使用 Postman 测试所有接口
  - [ ] 编写单元测试
  - [ ] 测试边界情况和异常处理

**完成标准（每个资源）：**
- 所有 CRUD 接口正常工作
- Swagger 文档完整
- 单元测试通过

---

#### 6. 文件上传 API（如需要）（4-8小时）

- [ ] **文件上传实现**
  - [ ] POST /api/upload
  - [ ] 接收文件（限制大小和类型）
  - [ ] 保存到本地或云存储（OSS/S3）
  - [ ] 返回文件 URL

- [ ] **图片处理**（可选）
  - [ ] 图片压缩
  - [ ] 生成缩略图
  - [ ] 图片格式转换

**完成标准：**
- 文件可以正常上传
- 文件 URL 可以正常访问

---

#### 7. 搜索和筛选 API（4-8小时）

- [ ] **搜索功能**
  - [ ] 实现关键词搜索（LIKE 查询）
  - [ ] 实现全文搜索（如需要，使用 Elasticsearch）
  - [ ] 支持模糊搜索

- [ ] **筛选功能**
  - [ ] 实现多条件筛选
  - [ ] 实现日期范围筛选
  - [ ] 实现标签筛选

- [ ] **排序功能**
  - [ ] 支持按多个字段排序
  - [ ] 支持升序/降序

- [ ] **分页功能**
  - [ ] 实现 offset-limit 分页
  - [ ] 或实现游标分页（cursor-based）

**完成标准：**
- 搜索功能正常
- 筛选和排序正常
- 分页性能良好

---

### Week 21-22：后端优化和部署（20-40小时）

#### 8. 性能优化（8-15小时）

- [ ] **数据库优化**
  - [ ] 添加索引（加快查询速度）
  - [ ] 优化慢查询（使用 EXPLAIN 分析）
  - [ ] 实现数据库连接池
  - [ ] 使用预编译语句（防止 SQL 注入）

- [ ] **缓存优化**
  - [ ] 安装 Redis
  - [ ] 集成 Redis 到 Go 项目
  - [ ] 缓存热点数据（用户信息、列表数据等）
  - [ ] 实现缓存过期和更新策略

- [ ] **API 性能优化**
  - [ ] 使用 Gzip 压缩响应
  - [ ] 实现 API 限流（防止滥用）
  - [ ] 实现请求去重
  - [ ] 异步处理耗时任务

**完成标准：**
- API 响应时间 < 200ms
- 缓存命中率 > 80%
- 数据库查询优化

---

#### 9. 安全加固（6-12小时）

- [ ] **输入验证**
  - [ ] 验证所有用户输入
  - [ ] 防止 SQL 注入（使用 ORM）
  - [ ] 防止 XSS 攻击（转义输出）
  - [ ] 防止 CSRF 攻击

- [ ] **认证和授权**
  - [ ] 确保所有需要认证的接口都有中间件保护
  - [ ] 实现权限检查（RBAC，如需要）
  - [ ] 实现 Token 过期和刷新

- [ ] **HTTPS 配置**
  - [ ] 配置 SSL 证书（Let's Encrypt）
  - [ ] 强制 HTTPS
  - [ ] 配置安全 Headers（HSTS、CSP 等）

- [ ] **敏感信息保护**
  - [ ] 加密存储敏感数据（密码、支付信息）
  - [ ] 不在日志中记录敏感信息
  - [ ] 使用环境变量管理密钥

- [ ] **安全审计**
  - [ ] 使用 AI 审查代码安全性
  - [ ] 检查 OWASP Top 10 漏洞
  - [ ] 使用安全扫描工具

**完成标准：**
- 通过基本安全检查
- 无明显安全漏洞
- HTTPS 正常工作

---

#### 10. 部署准备（6-13小时）

- [ ] **Docker 配置**
  - [ ] 编写 Dockerfile
  - [ ] 编写 docker-compose.yml（包含 App、DB、Redis）
  - [ ] 测试 Docker 构建
  - [ ] 测试 Docker 运行

- [ ] **CI/CD 配置**（可选）
  - [ ] 配置 GitHub Actions
  - [ ] 自动测试
  - [ ] 自动构建 Docker 镜像
  - [ ] 自动部署到服务器

- [ ] **部署文档**
  - [ ] 编写部署步骤文档
  - [ ] 编写运维手册
  - [ ] 配置数据库备份

**完成标准：**
- Docker 镜像可以正常构建和运行
- 部署文档完整清晰

---

### Week 23-24：前后端联调（20-40小时）

#### 11. API 对接（15-30小时）

- [ ] **Flutter 配置**
  - [ ] 配置 API Base URL（dev/prod 环境）
  - [ ] 使用 Retrofit 或 Dio 生成 API 客户端
  - [ ] 实现请求拦截器（添加 Token）
  - [ ] 实现响应拦截器（错误处理、Token 刷新）

- [ ] **API 集成**
  - [ ] 对接用户认证 API（注册/登录/登出）
  - [ ] 对接业务 API（CRUD 操作）
  - [ ] 对接文件上传 API（如有）
  - [ ] 对接搜索和筛选 API（如有）
  - [ ] 测试所有 API 接口

- [ ] **数据流测试**
  - [ ] 测试数据创建流程
  - [ ] 测试数据读取和展示
  - [ ] 测试数据更新流程
  - [ ] 测试数据删除流程
  - [ ] 测试离线缓存策略

- [ ] **错误处理**
  - [ ] 处理网络错误
  - [ ] 处理服务器错误（4xx/5xx）
  - [ ] 处理认证过期
  - [ ] 统一错误提示

**完成标准：**
- 前后端完全打通
- 所有功能正常工作
- 错误处理完善

---

#### 12. 压力测试（5-10小时）

- [ ] **性能测试**
  - [ ] 使用 Postman/JMeter 测试 API 性能
  - [ ] 模拟并发请求（100/500/1000 并发）
  - [ ] 记录响应时间和错误率
  - [ ] 找出性能瓶颈

- [ ] **优化**
  - [ ] 优化慢接口
  - [ ] 增加缓存
  - [ ] 优化数据库查询
  - [ ] 调整服务器配置

**完成标准：**
- API 能承受预期的并发量
- 响应时间在可接受范围内

---

## 🤖 本阶段需要问 AI 的问题

### BaaS 集成问题

**问题 1：Supabase 数据库设计**
```
我的应用需要以下功能：
[列出功能]

请帮我设计 Supabase 数据库结构：
1. 列出所有需要的表
2. 定义每个表的字段（字段名/类型/约束）
3. 设计表之间的关系（外键）
4. 提供创建表的 SQL 语句
5. 配置 Row Level Security 策略
6. 建议需要的索引

输出格式：完整的数据库设计文档 + SQL 脚本
```

**问题 2：Supabase Flutter 集成**
```
我需要在 Flutter 中集成 Supabase。

功能需求：
- 用户认证（邮箱登录）
- 数据 CRUD 操作
- 文件上传
- 实时订阅（可选）

请提供完整的集成代码，包括：
1. Supabase 初始化代码
2. 用户认证代码（注册/登录/登出）
3. 数据 CRUD 代码（增删改查）
4. 文件上传代码
5. 错误处理

输出格式：完整的 Flutter 代码 + 说明
```

---

### Go 后端开发问题

**问题 3：生成 Go 项目架构**
```
我需要创建一个 Go Web API 项目，使用 Gin + GORM。

功能需求：
- 用户认证（JWT）
- [列出主要功能模块]

请帮我：
1. 生成完整的项目目录结构
2. 提供 main.go 启动代码
3. 数据库配置和连接代码（PostgreSQL）
4. JWT 中间件代码
5. 统一的错误处理和日志
6. Docker 和 docker-compose 配置文件
7. Makefile（常用命令）

输出格式：完整的项目架构 + 代码模板
```

**问题 4：生成 RESTful API 代码**
```
我需要创建一个 RESTful API 来管理 [资源名称]。

数据模型：
- 字段1：类型（说明）
- 字段2：类型（说明）
...

需要的接口：
- POST /api/[resources] - 创建
- GET /api/[resources] - 列表（带分页、搜索、排序）
- GET /api/[resources]/:id - 详情
- PUT /api/[resources]/:id - 更新
- DELETE /api/[resources]/:id - 删除

请生成：
1. GORM Model 定义（带验证标签）
2. Repository 层代码（数据访问）
3. Service 层代码（业务逻辑）
4. Handler 层代码（HTTP 处理器）
5. Router 配置代码
6. 请求/响应 DTO 结构体
7. Swagger 注释
8. 单元测试代码

输出格式：完整的分层代码 + 测试代码
```

**问题 5：代码安全审查**
```
请审查以下 Go API 代码的安全性：

[粘贴代码]

检查项：
1. SQL 注入风险
2. XSS 攻击风险
3. 越权访问漏洞
4. 敏感信息泄露
5. 输入验证不足
6. CORS 配置安全性
7. JWT Token 安全性

请提供：
- 发现的安全问题（按严重程度分级）
- 修复建议和代码
- 安全最佳实践

输出格式：安全审查报告 + 修复代码
```

**问题 6：性能优化**
```
我的 Go API 性能不佳：

问题描述：
- [描述性能问题，如"查询慢"、"并发低"等]

相关代码：
[粘贴代码]

数据库查询：
[粘贴 SQL 或 GORM 查询代码]

请帮我：
1. 分析性能瓶颈
2. 提供优化方案（代码级别）
3. 数据库索引建议
4. 缓存策略建议
5. 并发优化建议

输出格式：性能优化方案 + 优化后的代码
```

---

### 部署和运维问题

**问题 7：Docker 部署配置**
```
请为我的 Go API 项目生成 Docker 部署方案：

技术栈：
- Go API（Gin）
- PostgreSQL
- Redis

要求：
1. Dockerfile（多阶段构建，优化镜像大小）
2. docker-compose.yml（包含 App/DB/Redis）
3. 环境变量配置（.env 示例）
4. Nginx 反向代理配置（HTTPS）
5. 自动重启策略
6. 日志持久化
7. 数据卷挂载

输出格式：完整的 Docker 配置文件 + 部署文档
```

**问题 8：服务器部署步骤**
```
我需要将 Go API 部署到云服务器。

服务器信息：
- 系统：Ubuntu 22.04
- 配置：2核4G
- 域名：[你的域名]

请提供详细的部署步骤：
1. 服务器环境配置（安装 Docker、Nginx 等）
2. 上传代码和配置文件
3. 使用 Docker Compose 启动服务
4. 配置 Nginx 反向代理
5. 配置 HTTPS（Let's Encrypt）
6. 配置域名解析
7. 配置防火墙
8. 配置数据库备份
9. 配置日志轮转
10. 配置监控和告警（可选）

输出格式：详细的部署步骤文档（每步都有命令）
```

---

## 📊 本阶段交付物清单

### 使用 BaaS 方案

- [ ] Supabase/Firebase 项目配置
- [ ] 数据库表结构设计文档
- [ ] Flutter 集成代码
- [ ] API 调用文档
- [ ] 测试报告

### 自建 Go 后端方案

- [ ] 完整的 Go API 代码
- [ ] 数据库设计文档和迁移脚本
- [ ] Swagger API 文档
- [ ] 单元测试代码
- [ ] Docker 配置文件
- [ ] 部署文档和运维手册
- [ ] 性能测试报告
- [ ] 安全审计报告

---

## 🎯 完成标准

### BaaS 方案

- ✅ BaaS 服务正常工作
- ✅ Flutter 可以正常调用 API
- ✅ 用户可以注册和登录
- ✅ 数据可以正常读写
- ✅ 文件可以正常上传

### 自建后端方案

- ✅ 所有 API 接口正常工作
- ✅ Swagger 文档完整
- ✅ 单元测试覆盖率 > 60%
- ✅ 性能测试通过
- ✅ 安全审计通过
- ✅ 前后端完全打通
- ✅ 可以部署到生产环境

---

## ⚠️ 常见问题和注意事项

### 技术选型建议

1. **新手建议**：使用 Supabase，快速上线，降低复杂度
2. **有经验开发者**：可以选择自建 Go 后端，更灵活可控
3. **预算有限**：使用 BaaS 免费额度，节省服务器成本
4. **数据敏感**：自建后端，数据完全自主可控

### Go 开发最佳实践

1. **项目结构**：使用分层架构，代码清晰可维护
2. **错误处理**：统一错误响应格式，友好的错误提示
3. **日志记录**：记录关键操作和错误，方便排查问题
4. **安全性**：输入验证、SQL 注入防护、XSS 防护
5. **性能**：使用缓存、数据库索引、连接池

---

**上一阶段：** [PHASE_2_FLUTTER_DEVELOPMENT.md](./PHASE_2_FLUTTER_DEVELOPMENT.md)

**下一阶段：** [PHASE_4_TESTING_OPTIMIZATION.md](./PHASE_4_TESTING_OPTIMIZATION.md)
